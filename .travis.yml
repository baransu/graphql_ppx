language: generic
os:
  - linux
  - osx
sudo: required
services:
  - docker

before_install:
  - bash -e ci/travis_before_install.sh
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then export TARGET_NAME=darwin-x64; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then export TARGET_NAME=linux-x64; fi

before_script:
  - IS_GRAPHQL_PPX_CI=true yarn
  - "./ci/before_script_$TRAVIS_OS_NAME.sh"

script:
  - "./ci/build_script_$TRAVIS_OS_NAME.sh"
  - make only-test TARGET_BUCKLESCRIPT=1
  - NODE_ENV=production make only-test TARGET_BUCKLESCRIPT=1
  - mv graphql_ppx.exe graphql_ppx-$TARGET_NAME.exe

deploy:
  provider: releases
  skip_cleanup: true
  file_glob: true
  file: graphql_ppx-*.exe
  api_key:
    secure: $GH_TOKEN
  on:
    tags: true
    repo: baransu/graphql_ppx
    branch: release

jobs:
  include:
    - stage: Wait for binaries to become available
      addons:
        apt:
          sources: []
          packages: []
      before_install: skip
      before_script: skip
      deploy: []
      script: bash -e ci/wait_for_builds.sh

    - stage: Deploy to npmjs
      addons:
        apt:
          sources: []
          packages: []
      before_install: skip
      before_script: skip
      script:
        - bash -e ci/download_binaries.sh

      deploy:
        provider: npm
        email: tomaszcichocinski@gmail.com
        skip_cleanup: true
        api_key:
          secure: Y1rI99NKIJ88vBWjJRFU/tsvY5t+ShAUi/hEx4Qzv5sEdhWtxbInqTjG5g4KtY1n0YXiyVmjF2H1HkK+UOUqE/gd98ZICUHQjgWBZ4WcRaQHVBqrQ9aCxVjHPHpLiEbyg15cwWBg5BJW18D6P7J9od+Ej9uGtcLruU4FIL7byfGbNsL6w1WjNuh/wc2A8Ht2mOVSoRqnuf0S9aWO5JVjapdqMmYi2SP23XK4yBR+ScdMgmzs7gNVtyNp1Yy/SzXwu3Tb6s8YjhpHz4szuCQ3Dgo2+9IDtce2yIOVM8W2JhoUqN1VALqCZeiLPvhrKc66jS9ZDvzOPcPX697y+EcceLQx3PYrDobIhssDbwYfj+B9ezkT9DERivMGtZ4xN/VzoTYeADWOUZunp5mod1uKHQkeY1vP+XeiZ3udkcWTr+T6epBTnF8QOx4QMuQ0VqshTwPCmeLmbub9eM2QQopoBHJ4ZdnESGZwtn71Jh7BAZtzRDKhp4NLh3I5mZQmfPpL093/RIGD8zp7mVUrhY0UMK4ovRtPXTedhf2toKcfXPzjBtbKFoDOLaloVSaIqSSSn0NTb7xr4L8DvRv7tMFJzMSYBgyjyApAMW6x3UD6BzDWJGmAdS3cOpaDCgJpPD4qOlmqvtgeQRxO9zHTE35lW5WRGxXfcoy/nwW0qeVJYDQ=
        on:
          tags: true
          repo: baransu/graphql_ppx
          branch: release
